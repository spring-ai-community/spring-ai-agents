# Build-capable image with JDK + Maven + Node + CLIs
FROM eclipse-temurin:17-jdk-jammy

# OS dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git python3 python3-pip ca-certificates curl \
 && rm -rf /var/lib/apt/lists/*

# Maven installation
ARG MAVEN_VERSION=3.9.11
RUN curl -fsSL https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
 | tar -xz -C /opt && ln -s /opt/apache-maven-${MAVEN_VERSION}/bin/mvn /usr/local/bin/mvn

# Node LTS (matching GitHub runners)
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
 && apt-get update && apt-get install -y --no-install-recommends nodejs \
 && rm -rf /var/lib/apt/lists/*

# Install CLIs EXACTLY as proven in CI (as root for global install)
# Updated for Claude Code 2.0 release (October 2025)
ARG CLAUDE_CODE_VERSION=latest
ARG GEMINI_CLI_VERSION=latest
ARG VENDIR_VERSION=0.44.0

# Install Claude Code CLI from npm globally
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION} --silent
# Install official Gemini CLI from npm
RUN npm install -g @google/gemini-cli@${GEMINI_CLI_VERSION} --silent

# Install vendir CLI for context engineering
RUN curl -fsSL https://github.com/vmware-tanzu/carvel-vendir/releases/download/v${VENDIR_VERSION}/vendir-linux-amd64 \
    -o /usr/local/bin/vendir && chmod +x /usr/local/bin/vendir

# Create non-root user and workspace
# GitHub Actions container jobs use specific paths:
# - HOME=/github/home
# - WORKSPACE=/__w/[owner]/[repo]
RUN useradd -m agent && \
    mkdir -p /work /github/home /__w /home/agent/.m2 /github/home/.m2 && \
    chown -R agent:agent /work /github /__w /home/agent
USER agent
ENV HOME=/github/home
WORKDIR /work

# Verify installations work
RUN echo "=== Verifying CLI installations ===" && \
    claude --version && echo "✅ Claude CLI verified" && \
    gemini --version && echo "✅ Gemini CLI verified" && \
    vendir --version && echo "✅ Vendir CLI verified"

CMD ["sleep", "infinity"]