name: Publish Snapshot

on:
  push:
    branches: [ "main" ]

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    name: Validate Commit Messages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          echo "Checking commit messages for AI attribution..."

          # Check the last commit that was pushed
          COMMIT=$(git rev-parse HEAD)
          echo "Checking commit: $COMMIT"
          COMMIT_MSG=$(git log --format=%B -n 1 $COMMIT)

          FOUND_ATTRIBUTION=false

          # Check for Claude attribution patterns
          if echo "$COMMIT_MSG" | grep -q "ü§ñ.*Claude Code"; then
            echo "‚ùå ERROR: Commit $COMMIT contains Claude Code attribution"
            echo "Found: $(echo "$COMMIT_MSG" | grep "ü§ñ.*Claude Code")"
            FOUND_ATTRIBUTION=true
          fi

          if echo "$COMMIT_MSG" | grep -q "Co-Authored-By.*Claude"; then
            echo "‚ùå ERROR: Commit $COMMIT contains Claude co-authoring"
            echo "Found: $(echo "$COMMIT_MSG" | grep "Co-Authored-By.*Claude")"
            FOUND_ATTRIBUTION=true
          fi

          if [ "$FOUND_ATTRIBUTION" = true ]; then
            echo ""
            echo "üö´ BLOCKING SNAPSHOT PUBLICATION"
            echo "Cannot publish snapshots with AI attribution in commit messages."
            echo ""
            echo "üí° To fix this:"
            echo "1. Use 'git rebase -i' to edit the problematic commit"
            echo "2. Remove the Claude attribution lines from commit message"
            echo "3. Force push the corrected commit"
            echo ""
            echo "See CLAUDE.md for commit message guidelines."
            exit 1
          else
            echo "‚úÖ Commit message is clean - proceeding with snapshot publication"
          fi

  publish:
    needs: validate-commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code --silent
          echo "‚úÖ Claude Code CLI installed via npm"

      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli --silent
          echo "‚úÖ Gemini CLI installed via npm"

      - name: Verify CLI installations
        run: |
          echo "=== Verifying CLI installations ==="
          if command -v claude >/dev/null 2>&1; then
            echo "‚úÖ Claude CLI verified: $(claude --version 2>&1)"
          else
            echo "‚ùå Claude CLI not found in PATH"
            echo "PATH: $PATH"
            ls -la /usr/local/bin/ | grep claude || echo "No claude in /usr/local/bin/"
            exit 1
          fi
          if command -v gemini >/dev/null 2>&1; then
            echo "‚úÖ Gemini CLI verified: $(gemini --version 2>&1)"
          else
            echo "‚ùå Gemini CLI not found in PATH"
            echo "PATH: $PATH"
            ls -la /usr/local/bin/ | grep gemini || echo "No gemini in /usr/local/bin/"
            exit 1
          fi

      - name: Deploy SNAPSHOT to Maven Central (via Central Publisher)
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mvn --batch-mode --update-snapshots deploy