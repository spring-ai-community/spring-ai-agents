name: CI/CD build

on:
  schedule:
    # Daily builds at reasonable intervals
    - cron: '0 9 * * 1-5'    # 9:00 AM UTC weekdays
    - cron: '0 21 * * 1-5'   # 9:00 PM UTC weekdays
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'spring-ai-community' }}
    concurrency:
      group: continuous-integration-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        java-version: [17, 21]
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Claude Code CLI
        run: |
          # Install Claude Code CLI from npm
          npm install -g @anthropic-ai/claude-code
          # Verify installation
          claude-code --version || echo "Claude Code CLI installed"

      - name: Install Gemini CLI
        run: |
          # Install Gemini CLI using the official installer
          curl -fsSL https://raw.githubusercontent.com/google-gemini/gemini-cli/main/scripts/install.sh | bash
          # Add to PATH for this session
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Also try alternative installation path
          echo "$HOME/bin" >> $GITHUB_PATH
          # Make sure the binary is executable
          chmod +x "$HOME/.local/bin/gemini" 2>/dev/null || true
          chmod +x "$HOME/bin/gemini" 2>/dev/null || true

      - name: Verify CLI installations
        run: |
          echo "=== PATH verification ==="
          echo "PATH: $PATH"
          echo ""
          echo "=== Claude Code CLI ==="
          which claude-code || echo "Claude Code CLI not found in PATH"
          claude-code --version || echo "Claude Code CLI version check failed"
          npm list -g @anthropic-ai/claude-code || echo "Claude Code npm package check failed"
          echo ""
          echo "=== Gemini CLI ==="
          which gemini || echo "Gemini CLI not found in PATH"
          ls -la "$HOME/.local/bin/" | grep gemini || echo "Gemini not found in .local/bin"
          ls -la "$HOME/bin/" | grep gemini || echo "Gemini not found in bin"
          find /usr/local -name "*gemini*" 2>/dev/null || echo "Gemini not found in /usr/local"
          gemini --version || echo "Gemini CLI version check failed"
          echo ""
          echo "=== Environment ==="
          env | grep -i gemini || echo "No Gemini env vars"
          env | grep -i anthropic || echo "No Anthropic env vars"

      - name: Build and test with Maven
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: ./mvnw --batch-mode clean test

      - name: Generate Java docs
        if: github.ref == 'refs/heads/main' && matrix.java-version == '17'
        run: ./mvnw --batch-mode javadoc:aggregate

      - name: Build documentation
        if: github.ref == 'refs/heads/main' && matrix.java-version == '17'
        run: ./mvnw clean antora:antora -pl docs