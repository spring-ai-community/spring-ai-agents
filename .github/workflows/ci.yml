name: CI/CD build

on:
  schedule:
    # Daily builds at reasonable intervals
    - cron: '0 9 * * 1-5'    # 9:00 AM UTC weekdays
    - cron: '0 21 * * 1-5'   # 9:00 PM UTC weekdays
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'spring-ai-community' }}
    concurrency:
      group: continuous-integration-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Claude Code CLI
        run: |
          # Install Claude Code CLI from npm globally
          npm install -g @anthropic-ai/claude-code
          # Find where npm installed it and add to PATH
          NPM_BIN=$(npm bin -g)
          echo "$NPM_BIN" >> $GITHUB_PATH
          # Also check the actual location
          ls -la /usr/local/lib/node_modules/@anthropic-ai/claude-code/bin/ || true
          # Create symlink if needed
          sudo ln -sf /usr/local/lib/node_modules/@anthropic-ai/claude-code/bin/claude-code /usr/local/bin/claude-code || true

      - name: Install Gemini CLI
        run: |
          # Create directories
          mkdir -p "$HOME/.local/bin"
          mkdir -p "$HOME/bin"
          # Try pip installation first (most reliable)
          pip install google-generativeai[cli] || true
          # Try the official installer
          curl -fsSL https://cli.gemini.google.com/install.sh 2>/dev/null | bash || true
          # Try direct download if available
          curl -L -o "$HOME/.local/bin/gemini" "https://github.com/google-gemini/gemini-cli/releases/latest/download/gemini-linux-amd64" 2>/dev/null || true
          chmod +x "$HOME/.local/bin/gemini" 2>/dev/null || true
          # Add paths
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Verify CLI installations
        run: |
          echo "=== PATH verification ==="
          echo "PATH: $PATH"
          echo ""
          echo "=== Claude Code CLI ==="
          if ! which claude-code; then
            echo "ERROR: Claude Code CLI not found in PATH"
            echo "Checking npm installation..."
            npm list -g @anthropic-ai/claude-code || true
            ls -la /usr/local/lib/node_modules/@anthropic-ai/claude-code/bin/ || true
            exit 1
          fi
          claude-code --version || exit 1
          echo "✅ Claude Code CLI verified"
          echo ""
          echo "=== Gemini CLI ==="
          if ! which gemini; then
            echo "ERROR: Gemini CLI not found in PATH"
            echo "Checking installation locations..."
            ls -la "$HOME/.local/bin/" 2>/dev/null || echo ".local/bin not found"
            ls -la "$HOME/bin/" 2>/dev/null || echo "bin not found"
            find /usr/local -name "*gemini*" 2>/dev/null || echo "No gemini in /usr/local"
            which genai 2>/dev/null && echo "Found genai command instead" || echo "No genai command either"
            exit 1
          fi
          gemini --version || exit 1
          echo "✅ Gemini CLI verified"

      - name: Build and test with Maven
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: ./mvnw --batch-mode clean test

      - name: Generate Java docs
        if: github.ref == 'refs/heads/main'
        run: ./mvnw --batch-mode javadoc:aggregate

      - name: Build documentation
        if: github.ref == 'refs/heads/main'
        run: ./mvnw clean antora:antora -pl docs