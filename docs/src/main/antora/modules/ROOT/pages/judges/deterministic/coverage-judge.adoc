= Coverage Judge
:page-title: Coverage Judge - JaCoCo Integration
:toc: left
:tabsize: 2

The `CoverageJudge` provides deterministic verification of code coverage targets using JaCoCo reports. It's a numerical score judge that compares actual coverage percentages against target thresholds.

== Overview

**Purpose**: Verify that agent-generated tests achieve a minimum coverage threshold

**Type**: Deterministic (numerical comparison)

**Use Case**: Code coverage improvement agents, CI/CD quality gates

== Basic Usage

[source,java]
----
import org.springaicommunity.agents.judge.coverage.CoverageJudge;

// Create judge with 80% target coverage
CoverageJudge judge = new CoverageJudge(80.0);

// Use with agent
AgentClientResponse response = agentClient
    .goal("Increase JaCoCo test coverage to 80%")
    .advisors(JudgeAdvisor.builder().judge(judge).build())
    .run();

// Check results
Judgment judgment = response.getJudgment();
if (judgment.pass()) {
    System.out.println("Coverage target achieved!");
    NumericalScore score = (NumericalScore) judgment.score();
    System.out.println("Final coverage: " + score.value() + "%");
} else {
    System.out.println("Coverage target not met: " + judgment.reasoning());
}
----

== How It Works

The `CoverageJudge` follows a three-step verification process:

1. **Parse JaCoCo Report** - Read `target/site/jacoco/jacoco.xml` generated by Maven
2. **Extract Metrics** - Parse line, branch, and method coverage percentages
3. **Compare to Target** - Return pass/fail based on threshold comparison

=== JaCoCo Report Format

The judge expects a standard JaCoCo XML report structure:

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<report name="rest-service-complete">
    <counter type="LINE" missed="2" covered="5"/>
    <counter type="BRANCH" missed="1" covered="7"/>
    <counter type="METHOD" missed="0" covered="5"/>
</report>
----

The parser calculates percentages:
----
Line Coverage = (covered / (covered + missed)) * 100
             = (5 / (5 + 2)) * 100
             = 71.4%
----

== Implementation Details

=== Constructor

[source,java]
----
public CoverageJudge(double targetCoverage) {
    this.targetCoverage = targetCoverage;
}
----

**Parameters**:
- `targetCoverage` - Minimum line coverage percentage (0-100)

=== Judge Method

[source,java]
----
@Override
public Judgment judge(JudgmentContext context) {
    // Parse JaCoCo report from workspace
    Path reportPath = context.workspace()
        .resolve("target/site/jacoco/jacoco.xml");

    CoverageMetrics metrics = JaCoCoReportParser.parseReport(reportPath);

    // Compare to target
    boolean passed = metrics.lineCoverage() >= targetCoverage;

    return Judgment.builder()
        .status(passed ? JudgmentStatus.PASS : JudgmentStatus.FAIL)
        .score(new NumericalScore(metrics.lineCoverage(), 0, 100))
        .reasoning(String.format(
            "Coverage: %.1f%% (target: %.1f%%)",
            metrics.lineCoverage(),
            targetCoverage
        ))
        .build();
}
----

== Usage Example

The xref:getting-started/code-coverage-agent.adoc[code coverage agent] uses this judge to verify coverage improvements:

[source,java]
----
// Setup phase - measure baseline
CoverageMetrics baseline = tryMeasureBaseline(workspace);
System.out.println("Baseline: " + baseline.lineCoverage() + "%");

// Execute phase - run agent with judge
CoverageJudge judge = new CoverageJudge(80.0);
AgentClientResponse response = agentClient
    .goal("Increase JaCoCo test coverage to 80%")
    .advisors(JudgeAdvisor.builder().judge(judge).build())
    .run();

// Evaluate phase - check results
CoverageMetrics finalCov = measureCoverage(workspace);
System.out.println("Final: " + finalCov.lineCoverage() + "%");

// Results on Spring gs-rest-service:
// Baseline: 0.0%
// Final: 71.4%
// Improvement: +71.4 percentage points
----

== Coverage Metrics Record

The judge uses the `CoverageMetrics` record from the JaCoCo parser:

[source,java]
----
public record CoverageMetrics(
    double lineCoverage,      // 0-100
    double branchCoverage,    // 0-100
    double methodCoverage,    // 0-100
    int linesCovered,
    int linesTotal,
    int branchesCovered,
    int branchesTotal,
    int methodsCovered,
    int methodsTotal,
    String summary
) {}
----

== Error Handling

The judge handles common failure scenarios gracefully:

**Missing JaCoCo Report**:
[source,java]
----
// Returns FAIL with 0% coverage
if (!Files.exists(reportPath)) {
    return new CoverageMetrics(0.0, 0.0, 0.0, 0, 0, 0, 0, 0, 0,
        "JaCoCo report not found");
}
----

**Parse Errors**:
[source,java]
----
// Returns FAIL with error message
catch (Exception e) {
    return new CoverageMetrics(0.0, 0.0, 0, 0, 0, 0, 0, 0,
        "Failed to parse: " + e.getMessage());
}
----

**Missing JaCoCo Plugin**:

If the project doesn't have JaCoCo configured, the agent can add it automatically. The xref:getting-started/code-coverage-agent.adoc[code coverage agent] detects missing plugins and includes configuration instructions in the prompt.

== Integration with Code Coverage Agent

The coverage agent uses a two-tier judge system:

**Tier 1: Coverage Judge (Implemented)**
- Deterministic numerical comparison
- Fast, reliable verification
- Measures coverage percentage improvement

**Tier 2: Test Quality Judge (Future)**
- AI-powered best practices validation
- Checks for @WebMvcTest, jsonPath(), AssertJ usage
- Validates Spring OSS conventions

See the xref:getting-started/code-coverage-agent.adoc#_future_enhancements[Future Enhancements] section for details on the planned Test Quality Judge.

== See Also

* xref:getting-started/code-coverage-agent.adoc[Code Coverage Agent] - Real-world usage
* xref:judges/index.adoc[Judge API Overview] - Core judge concepts
* xref:judges/deterministic/overview.adoc[Deterministic Judges] - Judge categories
