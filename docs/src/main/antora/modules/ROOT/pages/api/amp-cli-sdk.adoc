= Amp Agent SDK
:page-title: Amp Agent SDK Documentation
:toc: left
:tabsize: 2
:sectnums:

The Amp CLI SDK provides Java integration with Sourcegraph's Amp CLI, enabling autonomous coding capabilities in Spring applications.

== Overview

Amp is Sourcegraph's autonomous coding agent that can read, write, and execute code across entire codebases. The Spring AI Amp integration makes it easy to incorporate these capabilities into Java applications.

== Installation

=== Prerequisites

1. **Install Amp CLI**:
+
Follow the installation instructions at https://ampcode.com/[ampcode.com].

2. **Authentication** (Choose one method):
+
**Option A: Session Authentication (Recommended)**:
+
[source,bash]
----
amp login
----
+
**Option B: API Key**:
+
[source,bash]
----
export AMP_API_KEY="your-api-key-here"
----
+
Get your API key from the https://ampcode.com/settings[Amp Settings].
+
NOTE: Session authentication is preferred to avoid conflicts between authentication methods.

3. **Verify Installation**:
+
[source,bash]
----
amp --version
----

=== Maven Dependencies

Add the following dependencies to your `pom.xml`:

[source,xml]
----
<dependencies>
    <!-- Core AgentClient API -->
    <dependency>
        <groupId>org.springaicommunity.agents</groupId>
        <artifactId>spring-ai-agent-client</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </dependency>

    <!-- Amp integration -->
    <dependency>
        <groupId>org.springaicommunity.agents</groupId>
        <artifactId>spring-ai-amp-agent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
----

Or use the Spring Boot starter:

[source,xml]
----
<dependency>
    <groupId>org.springaicommunity.agents</groupId>
    <artifactId>spring-ai-starter-agent-amp</artifactId>
    <version>0.1.0-SNAPSHOT</version>
</dependency>
----

== Basic Usage

=== Quick Start

[source,java]
----
import org.springaicommunity.agents.client.AgentClient;
import org.springaicommunity.agents.client.AgentClientResponse;
import org.springaicommunity.agents.amp.AmpAgentModel;
import org.springaicommunity.agents.amp.AmpAgentOptions;
import org.springaicommunity.agents.ampsdk.AmpClient;

import java.nio.file.Paths;

public class AmpExample {
    public static void main(String[] args) {
        // 1. Create the Amp client
        AmpClient ampClient = AmpClient.create(
            Paths.get(System.getProperty("user.dir"))
        );

        // 2. Configure agent options
        AmpAgentOptions options = AmpAgentOptions.builder()
            .model("amp-default")
            .dangerouslyAllowAll(true)
            .build();

        // 3. Create the agent model
        AmpAgentModel agentModel = new AmpAgentModel(ampClient, options);

        // 4. Create AgentClient
        AgentClient agentClient = AgentClient.create(agentModel);

        // 5. Execute a goal
        AgentClientResponse response = agentClient.run(
            "Create a simple Calculator class with add, subtract, multiply, and divide methods"
        );

        System.out.println("Result: " + response.getResult());
        System.out.println("Success: " + response.isSuccessful());
    }
}
----

== Configuration

=== AmpClient

The `AmpClient` manages communication with the Amp CLI:

[source,java]
----
// Create with default working directory
AmpClient client = AmpClient.create();

// Create with specific working directory
Path projectPath = Paths.get("/path/to/project");
AmpClient client = AmpClient.create(projectPath);

// Create with custom Amp CLI path
AmpClient client = AmpClient.create(
    projectPath,
    "/custom/path/to/amp"
);
----

=== AmpAgentOptions

Configure Amp-specific behavior:

[source,java]
----
AmpAgentOptions options = AmpAgentOptions.builder()
    // Model selection (currently only amp-default available)
    .model("amp-default")

    // Execution settings
    .dangerouslyAllowAll(true)            // Allow modifications
    .timeout(Duration.ofMinutes(10))      // Execution timeout

    // CLI path (for non-standard installations)
    .executablePath("/custom/path/to/amp")

    .build();
----

=== Model Options

Currently available models:

[cols="1,2,1"]
|===
|Model |Description |Best For

|`amp-default`
|Default Amp model with full coding capabilities
|General-purpose coding tasks, refactoring, debugging
|===

NOTE: Amp uses Sourcegraph's models optimized for code understanding and generation.

== Advanced Features

=== Working Directory Management

Amp operates within a specific directory context:

[source,java]
----
// Configure working directory via client
AmpClient client = AmpClient.create(
    Paths.get("/path/to/microservice")
);

// Or via AgentClient fluent API
AgentClientResponse response = agentClient
    .goal("Add validation to the UserController")
    .workingDirectory("/path/to/microservice")
    .run();
----

=== Autonomous Mode

Control whether Amp can make changes without confirmation:

[source,java]
----
// Development mode - allow changes
AmpAgentOptions devOptions = AmpAgentOptions.builder()
    .dangerouslyAllowAll(true)
    .build();

// Analysis mode - read-only
AmpAgentOptions analysisOptions = AmpAgentOptions.builder()
    .dangerouslyAllowAll(false)
    .build();
----

CAUTION: The `dangerouslyAllowAll` option allows Amp to execute commands and make file changes without prompting. Use with caution in production environments.

=== Timeout Configuration

Set appropriate timeouts for different goal complexities:

[source,java]
----
// Quick tasks
AmpAgentOptions quickOptions = AmpAgentOptions.builder()
    .timeout(Duration.ofMinutes(2))
    .build();

// Complex refactoring
AmpAgentOptions complexOptions = AmpAgentOptions.builder()
    .timeout(Duration.ofMinutes(30))
    .build();
----

== Error Handling

=== Common Exceptions

[source,java]
----
import org.springaicommunity.agents.ampsdk.exceptions.AmpSDKException;

try {
    AgentClientResponse response = agentClient.run("Complex refactoring goal");

    if (!response.isSuccessful()) {
        System.err.println("Goal failed: " + response.getResult());
    }

} catch (AmpSDKException e) {
    // Amp CLI process failed
    System.err.println("Amp execution error: " + e.getMessage());

} catch (RuntimeException e) {
    // Other runtime errors (timeout, etc.)
    System.err.println("Unexpected error: " + e.getMessage());
}
----

=== Validation and Recovery

[source,java]
----
@Service
public class AmpService {

    private final AgentClient agentClient;

    public AmpService(AgentClient agentClient) {
        this.agentClient = agentClient;
    }

    public String refactorCode(String className, String requirements) {
        // Validate inputs
        if (className == null || className.trim().isEmpty()) {
            throw new IllegalArgumentException("Class name is required");
        }

        try {
            // First, analyze the code
            AgentClientResponse analysis = agentClient
                .goal("Analyze " + className + " and suggest improvements")
                .options(AmpAgentOptions.builder()
                    .dangerouslyAllowAll(false) // Read-only
                    .build())
                .run();

            if (!analysis.isSuccessful()) {
                throw new ServiceException("Analysis failed: " + analysis.getResult());
            }

            // Then perform refactoring
            AgentClientResponse refactoring = agentClient
                .goal("Refactor " + className + " based on: " + requirements)
                .options(AmpAgentOptions.builder()
                    .dangerouslyAllowAll(true) // Allow modifications
                    .build())
                .run();

            return refactoring.getResult();

        } catch (Exception e) {
            // Log error and return meaningful message
            log.error("Refactoring failed for class: {}", className, e);
            throw new ServiceException("Unable to refactor " + className + ": " + e.getMessage());
        }
    }
}
----

== Spring Boot Integration

=== Auto-Configuration

The Spring Boot starter provides automatic configuration:

[source,java]
----
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    // AmpClient, AmpAgentModel, and AgentClient are auto-configured

    @Bean
    public CommandLineRunner demo(AgentClient agentClient) {
        return args -> {
            AgentClientResponse response = agentClient.run(
                "Create a REST controller for managing users"
            );
            System.out.println(response.getResult());
        };
    }
}
----

=== Application Properties

Configure Amp via `application.yml`:

[source,yaml]
----
spring:
  ai:
    agents:
      amp:
        model: amp-default
        timeout: PT10M
        dangerously-allow-all: false
        executable-path: /custom/path/to/amp  # Optional
----

Or `application.properties`:

[source,properties]
----
spring.ai.agents.amp.model=amp-default
spring.ai.agents.amp.timeout=PT10M
spring.ai.agents.amp.dangerously-allow-all=false
spring.ai.agents.amp.executable-path=/custom/path/to/amp
----

=== Custom Configuration

Override auto-configuration with custom beans:

[source,java]
----
@Configuration
public class AmpConfiguration {

    @Bean
    public AmpAgentOptions customAmpOptions() {
        return AmpAgentOptions.builder()
            .model("amp-default")
            .dangerouslyAllowAll(true)
            .timeout(Duration.ofMinutes(15))
            .build();
    }

    @Bean
    public AmpClient customAmpClient() {
        return AmpClient.create(
            Paths.get("/path/to/project"),
            "/custom/path/to/amp"
        );
    }
}
----

== Best Practices

=== Goal Formulation

Write specific, actionable goals for Amp:

[source,java]
----
// Good: Specific and contextual
agentClient.run("Add input validation to UserController.createUser() method using Bean Validation annotations");

// Good: Clear scope and requirements
agentClient.run("Refactor PaymentService to use the Strategy pattern for different payment processors");

// Avoid: Vague requests
agentClient.run("Fix the code");

// Avoid: Overly broad scope
agentClient.run("Rewrite the entire application");
----

=== Security Considerations

Always be cautious with autonomous mode in production:

[source,java]
----
@Profile("development")
@Configuration
public class DevelopmentAmpConfig {

    @Bean
    public AmpAgentOptions devAmpOptions() {
        return AmpAgentOptions.builder()
            .dangerouslyAllowAll(true) // OK for development
            .build();
    }
}

@Profile("production")
@Configuration
public class ProductionAmpConfig {

    @Bean
    public AmpAgentOptions prodAmpOptions() {
        return AmpAgentOptions.builder()
            .dangerouslyAllowAll(false) // Safe for production
            .build();
    }
}
----

=== Resource Management

Monitor and limit resource usage:

[source,java]
----
@Component
public class AmpMonitor {

    private final MeterRegistry meterRegistry;
    private final AgentClient agentClient;

    public AmpMonitor(MeterRegistry meterRegistry, AgentClient agentClient) {
        this.meterRegistry = meterRegistry;
        this.agentClient = agentClient;
    }

    public String executeWithMetrics(String goal) {
        return Timer.Sample.start(meterRegistry)
            .stop(Timer.builder("amp.goal.duration")
                .tag("goal", goal.substring(0, Math.min(goal.length(), 50)))
                .register(meterRegistry))
            .recordCallable(() -> {
                Counter.builder("amp.goal.count").register(meterRegistry).increment();

                AgentClientResponse response = agentClient.run(goal);

                Counter.builder("amp.goal.result")
                    .tag("success", String.valueOf(response.isSuccessful()))
                    .register(meterRegistry)
                    .increment();

                return response.getResult();
            });
    }
}
----

== Troubleshooting

=== Common Issues

**Amp CLI Not Found**

Ensure Amp is installed and in your PATH:

[source,bash]
----
# Verify installation
amp --version

# Check PATH
which amp  # macOS/Linux
where amp  # Windows

# Set AMP_CLI_PATH for custom installation
export AMP_CLI_PATH=/path/to/amp
----

**API Key Issues**

Verify your API key configuration:

[source,bash]
----
# Check environment variable
echo $AMP_API_KEY

# Test with Amp CLI directly
amp --help

# Or use session authentication
amp login
----

**Permission Denied**

Ensure proper file permissions in working directory:

[source,bash]
----
# Check directory permissions
ls -la /path/to/project

# Fix if needed
chmod -R u+rw /path/to/project
----

**Timeout Issues**

Increase timeout for complex tasks:

[source,java]
----
AmpAgentOptions options = AmpAgentOptions.builder()
    .timeout(Duration.ofMinutes(30)) // Longer timeout
    .build();
----

**Stdin Prompt Issues**

Amp requires prompts to be passed via stdin (not command-line arguments). The SDK handles this automatically, but if you encounter issues:

[source,bash]
----
# Test manually
echo "Create a file test.txt" | amp --dangerously-allow-all -x
----

=== Debugging

Enable debug logging to troubleshoot issues:

[source,yaml]
----
logging:
  level:
    org.springaicommunity.agents.amp: DEBUG
    org.springaicommunity.agents.ampsdk: DEBUG
    org.springaicommunity.agents.client: DEBUG
----

=== Environment Variables

Key environment variables for testing and configuration:

[cols="1,2"]
|===
|Variable |Purpose

|`AMP_API_KEY`
|Amp API key for authentication (alternative to `amp login`)

|`AMP_CLI_PATH`
|Custom path to Amp CLI executable (for non-standard installations)
|===

== Differences from Claude Agent

If you're familiar with the Claude Agent integration, note these differences:

[cols="1,1,1"]
|===
|Feature |Claude |Amp

|Authentication
|`claude auth login` or `ANTHROPIC_API_KEY`
|`amp login` or `AMP_API_KEY`

|Autonomous mode flag
|`yolo(true)`
|`dangerouslyAllowAll(true)`

|Prompt passing
|Command-line argument
|Stdin (handled automatically by SDK)

|Model selection
|Multiple models (Sonnet, Haiku, Opus)
|Currently `amp-default` only

|Default timeout
|5 minutes
|3 minutes
|===

== Next Steps

* Learn about other agent integrations in xref:api/claude-code-sdk.adoc[Claude Agent SDK]
* See practical examples in xref:samples.adoc[Sample Agents]
* Compare with the standard API in xref:api/agentclient-vs-chatclient.adoc[AgentClient vs ChatClient]
